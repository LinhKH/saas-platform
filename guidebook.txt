/**

üéØ M·ª•c ti√™u Phase 0

  Project skeleton chu·∫©n production

  API-only (kh√¥ng Blade)

  Exception & response th·ªëng nh·∫•t

  S·∫µn s√†ng cho Auth / Wallet / Subscription

üß≠ L·ªò TR√åNH PHASE 1 (CHIA NH·ªé)
1. User model chu·∫©n API
2. Register
3. Login (device-based token)
4. Logout / revoke token
5. Protect routes
6. Email verification
7. Password reset
8. Rate limit login

=============================================================================================================
M√¨nh s·∫Ω gi·∫£i th√≠ch KH√îNG CODE, KH√îNG LARAVEL, ch·ªâ n√≥i t∆∞ duy h·ªá th·ªëng + v√≠ d·ª• ƒë·ªùi th·∫≠t.
ƒê·ªçc xong ph·∫ßn n√†y, b·∫°n s·∫Ω t·ª± th·∫•y Phase 2 l√† b·∫Øt bu·ªôc.

üß† 1. WALLET L√Ä G√å? (HI·ªÇU ƒê√öNG)
‚ùå Hi·ªÉu sai ph·ªï bi·∫øn

Wallet = 1 c·ªôt balance

user_id | balance


üëâ C√°ch n√†y ch·ªâ d√πng cho demo / toy app
üëâ KH√îNG d√πng cho h·ªá th·ªëng c√≥ ti·ªÅn th·∫≠t

‚úÖ Hi·ªÉu ƒë√∫ng (Senior / Fintech)

Wallet = T√ÄI KHO·∫¢N TI·ªÄN C·ª¶A NG∆Ø·ªúI D√ôNG

Gi·ªëng nh∆∞:

T√†i kho·∫£n ng√¢n h√†ng

V√≠ ƒëi·ªán t·ª≠ (Momo, ZaloPay)

V√≠ trong SaaS (credits)

üëâ Wallet KH√îNG PH·∫¢I ti·ªÅn,
üëâ Wallet l√† N∆†I QU·∫¢N L√ù D√íNG TI·ªÄN.

üß† 2. BALANCE L√Ä G√å?
üîπ Balance = ‚ÄúS·ªê D∆Ø HI·ªÜN T·∫†I‚Äù

V√≠ d·ª•:

V√≠ c·ªßa b·∫°n c√≥ 1.000.000‚Ç´

üëâ Balance tr·∫£ l·ªùi c√¢u h·ªèi:

‚ÄúB√¢y gi·ªù t√¥i c√≤n bao nhi√™u ti·ªÅn?‚Äù

‚ùó V·∫§N ƒê·ªÄ CH·∫æT NG∆Ø·ªúI

N·∫øu ch·ªâ c√≥ balance:

Ai thay ƒë·ªïi?

Thay ƒë·ªïi khi n√†o?

V√¨ sao thay ƒë·ªïi?

C√≥ b·ªã s·ª≠a nh·∫ßm kh√¥ng?

üëâ KH√îNG TRUY V·∫æT ƒê∆Ø·ª¢C

üß† 3. LEDGER L√Ä G√å? (PH·∫¶N QUAN TR·ªåNG NH·∫§T)
üî• Ledger = S·ªî C√ÅI K·∫æ TO√ÅN

Ledger l√† l·ªãch s·ª≠ T·∫§T C·∫¢ c√°c giao d·ªãch
KH√îNG BAO GI·ªú s·ª≠a / xo√°

üåç V√≠ d·ª• ƒë·ªùi th·∫≠t

Ng√¢n h√†ng KH√îNG l∆∞u m·ªói s·ªë d∆∞.

H·ªç l∆∞u:

+10.000.000 (l∆∞∆°ng)
-2.000.000  (mua laptop)
-200.000    (ƒÉn u·ªëng)


üëâ Ledger = danh s√°ch + / -

üîÅ Balance t·ª´ ƒë√¢u ra?

Balance = t·ªïng (+) ‚Äì t·ªïng (‚Äì) c·ªßa ledger

üëâ Balance c√≥ th·ªÉ t√≠nh l·∫°i
üëâ Ledger KH√îNG TH·ªÇ t·∫°o l·∫°i

üß† 4. V√å SAO PH·∫¢I C√ì LEDGER?
‚ùì C√¢u h·ªèi Senior lu√¥n h·ªèi

‚ÄúN·∫øu user n√≥i: T√¥i b·ªã tr·ª´ ti·ªÅn sai, b·∫°n l√†m g√¨?‚Äù

‚ùå Kh√¥ng c√≥ ledger

Kh√¥ng bi·∫øt sai ·ªü ƒë√¢u

Kh√¥ng audit ƒë∆∞·ª£c

Kh√¥ng rollback ƒë∆∞·ª£c

M·∫•t uy t√≠n / m·∫•t ti·ªÅn

‚úÖ C√≥ ledger

Xem t·ª´ng giao d·ªãch

Bi·∫øt ai, khi n√†o, v√¨ sao

C√≥ th·ªÉ b√π ti·ªÅn (compensate)

üëâ Ledger = s·ª± th·∫≠t duy nh·∫•t

üß† 5. BALANCE L√Ä ‚ÄúCACHE‚Äù, LEDGER L√Ä ‚ÄúSOURCE OF TRUTH‚Äù

ƒê√¢y l√† c√¢u n√≥i r·∫•t Senior

Ledger = truth

Balance = cache

üëâ Cache sai ‚Üí rebuild
üëâ Truth sai ‚Üí toang

üß† 6. IDEMPOTENCY L√Ä G√å?
üî• ƒê√¢y l√† kh√°i ni·ªám c·ª±c k·ª≥ quan tr·ªçng

Idempotency = g·ªçi 1 l·∫ßn hay 10 l·∫ßn, k·∫øt qu·∫£ CH·ªà T√çNH 1

üåç V√≠ d·ª• ƒë·ªùi th·∫≠t

B·∫°n chuy·ªÉn kho·∫£n:

M·∫°ng lag

App g·ª≠i l·∫°i request

Server nh·∫≠n 2 request gi·ªëng nhau

‚ùå Kh√¥ng idempotent:

Ti·ªÅn b·ªã tr·ª´ 2 l·∫ßn

‚úÖ Idempotent:

Request th·ª© 2 ‚Üí b·ªè qua

üß† 7. IDEMPOTENCY √ÅP D·ª§NG ·ªû ƒê√ÇU?
Nh·ªØng n∆°i B·∫ÆT BU·ªòC

Payment callback

Wallet credit/debit

Subscription renewal

Order paid

V√≠ d·ª•
external_txn_id = "stripe_abc_123"


N·∫øu ƒë√£ x·ª≠ l√Ω stripe_abc_123 r·ªìi ‚Üí
üëâ KH√îNG x·ª≠ l√Ω l·∫°i

üß† 8. DOUBLE-SPEND L√Ä G√å?
‚ùå V·∫•n ƒë·ªÅ

User c√≥ 100‚Ç´
G·ª≠i 2 request c√πng l√∫c:

Mua A: 80‚Ç´

Mua B: 80‚Ç´

üëâ N·∫øu kh√¥ng kho√°:

C·∫£ 2 c√πng th·∫•y balance = 100

Tr·ª´ ‚Üí -60

‚úÖ C√°ch Senior x·ª≠ l√Ω

Lock wallet

Check balance

Tr·ª´ ti·ªÅn

Commit

üëâ DB lock + transaction

üß† 9. T·ªîNG H·ª¢P T∆Ø DUY (R·∫§T QUAN TR·ªåNG)
Kh√°i ni·ªám	Tr·∫£ l·ªùi c√¢u h·ªèi
Wallet	T√†i kho·∫£n ti·ªÅn
Ledger	L·ªãch s·ª≠ giao d·ªãch
Balance	S·ªë d∆∞ hi·ªán t·∫°i
Idempotency	Tr√°nh x·ª≠ l√Ω tr√πng
Lock	Tr√°nh double-spend
üß† 10. T·∫†I SAO PHASE 2 KH√ì?

V√¨ Phase 2 bu·ªôc b·∫°n ph·∫£i:

Nghƒ© nh∆∞ k·∫ø to√°n

Nghƒ© nh∆∞ h·ªá th·ªëng t√†i ch√≠nh

Nghƒ© nh∆∞ backend production

üëâ Kh√¥ng c√≤n l√† CRUD n·ªØa.

üéØ N·∫æU B·∫†N HI·ªÇU ƒê·∫æN ƒê√ÇY, B·∫†N ƒê√É ƒê·∫†T ƒê∆Ø·ª¢C G√å?

Hi·ªÉu v√¨ sao Wallet ‚â† balance

Hi·ªÉu v√¨ sao ledger b·∫•t bi·∫øn

Hi·ªÉu v√¨ sao idempotency s·ªëng c√≤n

Hi·ªÉu v√¨ sao Phase 2 r·∫•t quan tr·ªçng

üëâ ƒê√¢y l√† t∆∞ duy Senior PHP / Laravel / Backend chung, kh√¥ng ri√™ng framework.

==========================================================================================
üß± PHASE 3 ‚Äî SUBSCRIPTION (SaaS CORE)
üéØ M·ª•c ti√™u Phase 3

Subscription theo lifecycle th·∫≠t

T√≠nh ph√≠ b·∫±ng Wallet

An to√†n v·ªõi retry / webhook

T√°ch Core vs Side-effect

Chu·∫©n b·ªã cho Payment gateway

üß† T∆Ø DUY C·ªêT L√ïI (NH·ªö K·ª∏)

‚ùå Subscription ‚â† c·ªôt is_active
‚úÖ Subscription = STATE MACHINE

üîÅ SUBSCRIPTION LIFECYCLE (CHU·∫®N SAAS)
trialing
   ‚Üì
active
   ‚Üì
past_due
   ‚Üì
cancelled
   ‚Üì
expired


trialing: d√πng th·ª≠

active: ƒëang tr·∫£ ti·ªÅn

past_due: gia h·∫°n th·∫•t b·∫°i

cancelled: user hu·ª∑

expired: h·∫øt hi·ªáu l·ª±c

üëâ State transition ph·∫£i h·ª£p l·ªá, kh√¥ng nh·∫£y b·ª´a.

üß≠ ROADMAP PHASE 3
3.1 Subscription model + migration
3.2 Plan (pricing)
3.3 Subscribe flow
3.4 Renew (billing cycle)
3.5 Cancel / Grace period
3.6 Events + Notifications
===========================================================================================
/**
 * TEST CASES
 * 2Ô∏è‚É£ RENEW SUCCESS ‚Üí MAIL RENEWED
 * 2.1 √âp subscription t·ªõi h·∫°n:
    UPDATE subscriptions
    SET current_period_end = NOW() - INTERVAL 5 DAY
    WHERE user_id = 1;
  * 2.2 n·∫°p ti·ªÅn v√†o v√≠ (ƒë·ªß ti·ªÅn):
    php artisan tinker
    app(\App\Services\Wallet\WalletService::class)->credit(1, 1000, 'topup_test', 'Topup for renewal'); // ti·ªÅn ph·∫£i nhi·ªÅu h∆°n so v·ªõi gi√° c·ªßa plan
    dispatch(new \App\Jobs\RenewSubscriptionsJob);
  * 2.3 Ki·ªÉm tra k·∫øt qu·∫£:
    ‚úÖ K·∫øt qu·∫£:

    status = active

    current_period_end ƒë∆∞·ª£c extend

    Log mail: "Subscription renewed"
  * 3Ô∏è‚É£ RENEW FAIL ‚Üí MAIL PAST_DUE
  * 3.1 √âp subscription t·ªõi h·∫°n:
      UPDATE subscriptions
      SET current_period_end = NOW() - INTERVAL 5 DAY
      WHERE user_id = 1;
  * 3.2 ƒê·∫£m b·∫£o v√≠ kh√¥ng ƒë·ªß ti·ªÅn (ho·∫∑c reset v√≠):
      php artisan tinker
      app(\App\Services\Wallet\WalletService::class)->debit(1, 9999, 'drain_wallet', 'Drain wallet'); // gi·∫£ s·ª≠ s·ªë d∆∞ kh√¥ng ƒë·ªß
  * 3.3 Ch·∫°y job:
      dispatch(new \App\Jobs\RenewSubscriptionsJob);
  * 3.4 Ki·ªÉm tra k·∫øt qu·∫£:
      ‚úÖ K·∫øt qu·∫£:
      status = past_due
      Log mail: "Payment failed, subscription past due"
  * 4Ô∏è‚É£ GRACE END ‚Üí MAIL EXPIRED
  * 4.1 √âp subscription sang past_due v√† h·∫øt grace period:
      UPDATE subscriptions
      SET status = 'past_due',
          updated_at = NOW() - INTERVAL 10 DAY,
          current_period_end = NOW() - INTERVAL 5 DAY
      WHERE user_id = 1;
  * 4.2 Ch·∫°y job:
      dispatch(new \App\Jobs\RenewSubscriptionsJob);
  * 4.3 Ki·ªÉm tra k·∫øt qu·∫£:
      ‚úÖ K·∫øt qu·∫£:
      status = expired
      Log mail: "Subscription expired"

  * 5Ô∏è‚É£ CANCEL ‚Üí MAIL CANCELLED
      Ch·ªâ test khi subscription ƒëang active ho·∫∑c trialing
  * 5.1 H·ªßy subscription:
      curl -X POST http://localhost:8000/api/subscription/cancel -H "Authorization: Bearer $TOKEN" -H "Accept: application/json"
  * 5.2 Ki·ªÉm tra k·∫øt qu·∫£:
      ‚úÖ K·∫øt qu·∫£:
      status = cancelled
      Log mail: "Subscription cancelled"

    * 6Ô∏è‚É£ RESUME ‚Üí MAIL RESUMED
      Ch·ªâ test khi subscription ƒëang ·ªü tr·∫°ng th√°i cancelled v√† trong th·ªùi gian c√≥ th·ªÉ resume (v√≠ d·ª•: ch∆∞a qu√° 7 ng√†y k·ªÉ t·ª´ khi h·ªßy)
  * 6.1 Resume subscription:
      curl -X POST http://localhost:8000/api/subscription/resume -H "Authorization: Bearer $TOKEN" -H "Accept: application/json"
  * 6.2 Ki·ªÉm tra k·∫øt qu·∫£:
      ‚úÖ K·∫øt qu·∫£:
      status = active
      cancelled_at = null
      current_period_end ƒë∆∞·ª£c t√≠nh l·∫°i d·ª±a tr√™n th·ªùi ƒëi·ªÉm resume
      Log mail: "Subscription resumed"
 */